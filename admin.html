<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel de Administración - Veterinaria Zona Animal</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Iconos de Phosphor Icons -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; }
        .modal-content { animation: slideUp 0.4s ease-out forwards; }
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="antialiased text-gray-900">

    <div class="flex min-h-screen">
        <!-- Barra Lateral -->
        <aside class="bg-gray-800 text-white w-64 space-y-6 py-7 px-2">
            <a href="#" class="text-white flex items-center space-x-2 px-4">
                <i class="ph-bold ph-paw-print text-cyan-400 text-3xl"></i>
                <span class="text-2xl font-extrabold">Zona Animal</span>
            </a>
            <nav>
                <a href="#" class="w-full flex items-center text-white bg-gray-700 py-2 px-4 rounded transition duration-200"><i class="ph-bold ph-shopping-bag-open mr-3"></i> Productos</a>
            </nav>
        </aside>

        <!-- Contenido Principal -->
        <main class="flex-1 p-6 md:p-10">
            <header class="flex justify-between items-center mb-8">
                <h1 id="main-title" class="text-3xl font-bold">Gestión de Productos</h1>
            </header>
            
            <section id="products">
                <div class="flex justify-end mb-4">
                    <button onclick="window.openProductModal()" class="bg-cyan-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-cyan-700 flex items-center gap-2"><i class="ph-bold ph-plus"></i> Agregar Producto</button>
                </div>
                <div class="bg-white p-6 rounded-2xl shadow-md overflow-x-auto">
                    <table class="w-full text-left">
                        <thead><tr class="border-b"><th class="py-3 px-4 font-semibold">Imagen</th><th class="py-3 px-4 font-semibold">Nombre</th><th class="py-3 px-4 font-semibold">Precio</th><th class="py-3 px-4 font-semibold">Categoría</th><th class="py-3 px-4 font-semibold">Acciones</th></tr></thead>
                        <tbody id="products-table-body">
                            <!-- Los productos se cargarán aquí -->
                        </tbody>
                    </table>
                </div>
            </section>
        </main>
    </div>

    <!-- Modal para Productos -->
    <div id="product-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, doc, updateDoc, addDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Tu configuración de Firebase se mantiene intacta
        const firebaseConfig = {
          apiKey: "AIzaSyCC-swKUQGU93xe_bc7Qts2nhFCji3ZeDs",
          authDomain: "zona-animal-pedidos.firebaseapp.com",
          projectId: "zona-animal-pedidos",
          storageBucket: "zona-animal-pedidos.appspot.com",
          messagingSenderId: "1028482666526",
          appId: "1:1028482666526:web:a136fa73b9b0d884389e0f"
        };
        const appId = firebaseConfig.projectId;

        let db;
        let allProducts = [];

        // --- DOM ELEMENTS ---
        const productsTableBody = document.getElementById('products-table-body');
        const productModal = document.getElementById('product-modal');

        // --- INICIALIZACIÓN ---
        async function init() {
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                await signInAnonymously(getAuth(app));
                listenToProducts();
            } catch (error) {
                console.error("Error al inicializar Firebase:", error);
                alert("No se pudo conectar a la base de datos. Revisa la consola y tu conexión a internet.");
            }
        }
        
        // --- LISTENER DE PRODUCTOS ---
        function listenToProducts() {
            const productsRef = collection(db, `/artifacts/${appId}/public/data/products`);
            onSnapshot(productsRef, (snapshot) => {
                allProducts = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                allProducts.sort((a, b) => a.name.localeCompare(b.name));
                renderProductsTable();
            }, (error) => {
                console.error("Error al escuchar cambios en productos: ", error);
                productsTableBody.innerHTML = `<tr><td colspan="5" class="text-center p-8 text-red-500">Error al cargar el catálogo.</td></tr>`;
            });
        }
        
        // --- RENDERIZADO DE LA TABLA ---
        function renderProductsTable() {
            productsTableBody.innerHTML = allProducts.length > 0 ? '' : `<tr><td colspan="5" class="text-center p-8 text-gray-500">No hay productos. Haz clic en "Agregar Producto" para empezar.</td></tr>`;
            allProducts.forEach(product => {
                const row = productsTableBody.insertRow();
                row.className = 'border-b hover:bg-gray-50';
                row.innerHTML = `
                    <td class="py-2 px-4"><img src="${product.imageUrl || 'https://placehold.co/64x64/eee/ccc?text=N/A'}" alt="${product.name}" class="w-12 h-12 object-cover rounded-md"></td>
                    <td class="py-3 px-4">${product.name}</td>
                    <td class="py-3 px-4 font-medium">$${(product.price || 0).toFixed(2)}</td>
                    <td class="py-3 px-4 text-gray-600">${product.category}</td>
                    <td class="py-3 px-4">
                        <button onclick="window.openProductModal('${product.id}')" class="text-cyan-600 hover:underline font-semibold mr-4">Editar</button>
                        <button onclick="window.deleteProduct('${product.id}')" class="text-red-600 hover:underline font-semibold">Borrar</button>
                    </td>`;
            });
        }
        
        // --- MODAL Y ACCIONES DE PRODUCTOS ---
        window.openProductModal = (productId = null) => {
            const isEditing = !!productId;
            const product = isEditing ? allProducts.find(p => p.id === productId) : {};
            productModal.innerHTML = `
                <div class="bg-white rounded-2xl shadow-xl max-w-lg w-full m-4 modal-content">
                    <form id="product-form" onsubmit="window.saveProduct(event, ${isEditing ? `'${product.id}'` : null})">
                        <header class="p-6 border-b flex justify-between items-center">
                            <h3 class="text-xl font-bold">${isEditing ? 'Editar' : 'Agregar'} Producto</h3>
                            <button type="button" onclick="window.closeModal('product-modal')" class="text-gray-400 hover:text-gray-700 text-2xl">&times;</button>
                        </header>
                        <div class="p-6 space-y-4">
                            <div><label class="block text-sm font-medium text-gray-700">Nombre</label><input type="text" id="product-name" value="${product.name || ''}" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3"></div>
                            <div><label class="block text-sm font-medium text-gray-700">Precio</label><input type="number" id="product-price" step="0.01" value="${product.price || ''}" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3"></div>
                            <div><label class="block text-sm font-medium text-gray-700">URL de Imagen</label><input type="url" id="product-image-url" value="${product.imageUrl || ''}" placeholder="https://ejemplo.com/imagen.jpg" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3"></div>
                            <div><label class="block text-sm font-medium text-gray-700">Categoría</label><select id="product-category" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 bg-white"><option value="Medicamentos" ${product.category === 'Medicamentos' ? 'selected' : ''}>Medicamentos</option><option value="Alimentos y Accesorios" ${product.category === 'Alimentos y Accesorios' ? 'selected' : ''}>Alimentos y Accesorios</option><option value="Agenda de Citas" ${product.category === 'Agenda de Citas' ? 'selected' : ''}>Agenda de Citas</option></select></div>
                            <div><label class="block text-sm font-medium text-gray-700">Tipo</label><select id="product-type" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 bg-white"><option value="product" ${product.type === 'product' ? 'selected' : ''}>Producto (se vende)</option><option value="service" ${product.type === 'service' ? 'selected' : ''}>Servicio (se agenda)</option></select></div>
                        </div>
                        <footer class="p-6 bg-gray-50 rounded-b-2xl flex justify-end gap-3">
                            <button type="button" onclick="window.closeModal('product-modal')" class="bg-gray-200 text-gray-800 font-bold py-2 px-4 rounded-lg">Cancelar</button>
                            <button type="submit" class="bg-cyan-600 text-white font-bold py-2 px-4 rounded-lg">Guardar</button>
                        </footer>
                    </form>
                </div>`;
            productModal.classList.remove('hidden');
        }

        window.closeModal = (modalId) => document.getElementById(modalId).classList.add('hidden');

        window.saveProduct = async (event, productId) => {
            event.preventDefault();
            const productData = {
                name: document.getElementById('product-name').value,
                price: parseFloat(document.getElementById('product-price').value),
                category: document.getElementById('product-category').value,
                type: document.getElementById('product-type').value,
                imageUrl: document.getElementById('product-image-url').value
            };
            if (!productData.name || isNaN(productData.price) || productData.price < 0) {
                return alert("Nombre y precio son requeridos y el precio no puede ser negativo.");
            }
            
            try {
                if (productId) {
                    await updateDoc(doc(db, `/artifacts/${appId}/public/data/products`, productId), productData);
                } else {
                    await addDoc(collection(db, `/artifacts/${appId}/public/data/products`), productData);
                }
                window.closeModal('product-modal');
            } catch (error) { console.error("Error al guardar producto:", error); }
        }

        window.deleteProduct = async (productId) => {
            if (!confirm("¿Estás seguro de que quieres borrar este producto?")) return;
            await deleteDoc(doc(db, `/artifacts/${appId}/public/data/products`, productId));
        }
        
        // --- NAVEGACIÓN (SIMPLIFICADA POR AHORA) ---
        function setupNavigation() {
            // Esta función puede expandirse después para manejar más secciones
            document.getElementById('nav-menu').addEventListener('click', (e) => {
                if (e.target.tagName === 'A') {
                    alert("Las otras secciones se habilitarán en el siguiente paso.");
                }
            });
        }
        
        init();
    </script>
</body>
</html>

