<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Zona Animal - Tienda y Veterinaria</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
        
        .gradient-bg { background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%); }
        .card-hover { transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .card-hover:hover { transform: translateY(-5px); box-shadow: 0 15px 30px -5px rgba(0, 0, 0, 0.1); }
        
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); backdrop-filter: blur(4px); }
        .modal.show { display: flex; align-items: center; justify-content: center; animation: fadeIn 0.2s ease-out; }
        
        .cart-sidebar { transform: translateX(100%); transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .cart-open .cart-sidebar { transform: translateX(0); }
        .cart-open .cart-overlay { opacity: 1; pointer-events: auto; }
        .cart-overlay { transition: opacity 0.3s ease; opacity: 0; pointer-events: none; }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        
        /* Loader */
        #loader { position: fixed; inset: 0; background: white; z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; transition: opacity 0.5s; }
    </style>
</head>
<body class="bg-gray-50 flex flex-col min-h-screen">

    <!-- Loader de Carga -->
    <div id="loader">
        <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-indigo-600 mb-4"></div>
        <h2 class="text-xl font-bold text-gray-700">Conectando con Zona Animal...</h2>
        <p class="text-gray-500 text-sm">Sincronizando productos en la nube</p>
    </div>

    <!-- Header -->
    <header class="gradient-bg text-white shadow-lg sticky top-0 z-40 bg-opacity-95 backdrop-blur">
        <div class="container mx-auto px-4 py-3">
            <div class="flex justify-between items-center">
                <div class="flex items-center space-x-3 group cursor-pointer" onclick="window.scrollToSection('hero')">
                    <div class="w-10 h-10 bg-white rounded-full flex items-center justify-center shadow-md group-hover:scale-110 transition-transform">
                        <span class="text-2xl">üêæ</span>
                    </div>
                    <h1 class="text-2xl font-bold tracking-tight">Zona Animal</h1>
                </div>
                
                <nav class="hidden md:flex space-x-8 font-medium">
                    <a href="#productos" onclick="window.scrollToSection('productos')" class="hover:text-yellow-300 transition-colors">Productos</a>
                    <a href="#citas" onclick="window.scrollToSection('citas')" class="hover:text-yellow-300 transition-colors">Citas</a>
                    <a href="#seguimiento" onclick="window.scrollToSection('seguimiento')" class="hover:text-yellow-300 transition-colors">Rastreo</a>
                    <a href="#admin" onclick="window.scrollToSection('admin')" class="hover:text-yellow-300 transition-colors">Admin</a>
                </nav>

                <div class="flex items-center space-x-4">
                    <button onclick="window.toggleCart()" class="relative p-2 hover:bg-white hover:bg-opacity-20 rounded-full transition-all group">
                        <span class="text-xl group-hover:scale-110 inline-block">üõí</span>
                        <span id="cart-count" class="absolute -top-1 -right-1 bg-red-500 text-white text-xs font-bold rounded-full w-5 h-5 flex items-center justify-center shadow-sm border border-white">0</span>
                    </button>
                    <button onclick="window.toggleMobileMenu()" class="md:hidden p-2 hover:bg-white hover:bg-opacity-20 rounded-lg">
                        <span class="text-xl">‚ò∞</span>
                    </button>
                </div>
            </div>
            
            <div id="mobile-menu" class="md:hidden hidden mt-4 pb-2 border-t border-white/20 pt-2 animate-[fadeIn_0.3s_ease]">
                <a href="#productos" onclick="window.scrollToSection('productos'); window.toggleMobileMenu();" class="block py-3 px-2 hover:bg-white/10 rounded">Productos</a>
                <a href="#citas" onclick="window.scrollToSection('citas'); window.toggleMobileMenu();" class="block py-3 px-2 hover:bg-white/10 rounded">Agendar Cita</a>
                <a href="#admin" onclick="window.scrollToSection('admin'); window.toggleMobileMenu();" class="block py-3 px-2 hover:bg-white/10 rounded">Admin</a>
            </div>
        </div>
    </header>

    <!-- Hero Section (Ajustado para m√≥viles: py-12, texto m√°s peque√±o en m√≥vil) -->
    <section id="hero" class="relative bg-gray-900 text-white py-12 md:py-20 overflow-hidden">
        <div class="absolute inset-0 opacity-30 bg-[url('https://images.unsplash.com/photo-1548199973-03cce0bbc87b?ixlib=rb-4.0.3&auto=format&fit=crop&w=1920&q=80')] bg-cover bg-center"></div>
        <div class="absolute inset-0 gradient-bg opacity-80"></div>
        <div class="container mx-auto px-4 text-center relative z-10">
            <h2 class="text-3xl md:text-6xl font-extrabold mb-6 leading-tight animate-[slideUp_0.6s_ease-out]">Cuidamos a tu<br>mejor amigo</h2>
            <p class="text-lg md:text-xl text-gray-100 mb-8 md:mb-10 max-w-2xl mx-auto animate-[slideUp_0.8s_ease-out]">Productos premium y atenci√≥n veterinaria profesional.</p>
            <div class="flex flex-col sm:flex-row gap-4 justify-center animate-[slideUp_1s_ease-out]">
                <button onclick="window.scrollToSection('productos')" class="bg-white text-indigo-600 px-8 py-3.5 rounded-full font-bold hover:bg-yellow-300 hover:text-indigo-800 transition-all shadow-lg">Ver Cat√°logo</button>
                <button onclick="window.scrollToSection('citas')" class="bg-transparent border-2 border-white text-white px-8 py-3.5 rounded-full font-bold hover:bg-white hover:text-indigo-600 transition-all">Agendar Cita</button>
            </div>
        </div>
    </section>

    <!-- Productos Section (Ajustado: py-10 en m√≥vil, gap reducido) -->
    <section id="productos" class="py-10 md:py-16 bg-white">
        <div class="container mx-auto px-4">
            <div class="text-center mb-8 md:mb-12">
                <h2 class="text-3xl font-bold text-gray-800 mb-4">Nuestros Productos</h2>
                <div class="w-20 h-1 bg-indigo-600 mx-auto rounded-full"></div>
            </div>

            <div class="flex flex-col md:flex-row justify-between items-center gap-4 mb-8 bg-gray-50 p-4 rounded-2xl shadow-inner">
                <div class="flex flex-wrap justify-center gap-2">
                    <button onclick="window.filterProducts('todos', this)" class="filter-btn bg-indigo-600 text-white px-4 py-2 md:px-5 rounded-full text-sm font-medium transition-all shadow-md">Todos</button>
                    <button onclick="window.filterProducts('alimento', this)" class="filter-btn bg-white text-gray-600 hover:bg-gray-100 px-4 py-2 md:px-5 rounded-full text-sm font-medium transition-all border">Alimento</button>
                    <button onclick="window.filterProducts('juguetes', this)" class="filter-btn bg-white text-gray-600 hover:bg-gray-100 px-4 py-2 md:px-5 rounded-full text-sm font-medium transition-all border">Juguetes</button>
                    <button onclick="window.filterProducts('medicamentos', this)" class="filter-btn bg-white text-gray-600 hover:bg-gray-100 px-4 py-2 md:px-5 rounded-full text-sm font-medium transition-all border">Medicamentos</button>
                    <button onclick="window.filterProducts('accesorios', this)" class="filter-btn bg-white text-gray-600 hover:bg-gray-100 px-4 py-2 md:px-5 rounded-full text-sm font-medium transition-all border">Accesorios</button>
                    <button onclick="window.filterProducts('producto', this)" class="filter-btn bg-white text-gray-600 hover:bg-gray-100 px-4 py-2 md:px-5 rounded-full text-sm font-medium transition-all border">Producto</button>
                </div>
                <div class="relative w-full md:w-auto">
                    <input type="text" id="search-product" oninput="window.searchProducts()" placeholder="Buscar producto..." class="w-full md:w-64 pl-10 pr-4 py-2 rounded-full border border-gray-300 focus:ring-2 focus:ring-indigo-500 outline-none">
                    <span class="absolute left-3 top-2.5 text-gray-400">üîç</span>
                </div>
            </div>

            <!-- Grid ajustado: gap-4 en m√≥vil, gap-8 en desktop -->
            <div id="products-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4 md:gap-8"></div>
        </div>
    </section>

    <!-- Citas Section (Ajustado: py-10 en m√≥vil, padding del form reducido) -->
    <section id="citas" class="py-10 md:py-16 bg-indigo-50">
        <div class="container mx-auto px-4">
            <div class="max-w-4xl mx-auto bg-white rounded-3xl shadow-xl overflow-hidden flex flex-col md:flex-row">
                <div class="md:w-1/3 bg-indigo-600 p-6 md:p-8 text-white flex flex-col justify-center">
                    <h3 class="text-xl md:text-2xl font-bold mb-4">Reserva tu cita</h3>
                    <p class="mb-6 text-indigo-100">Expertos en el cuidado de tu mascota.</p>
                    <ul class="space-y-3 text-sm">
                        <li class="flex items-center">‚úÖ Atenci√≥n personalizada</li>
                        <li class="flex items-center">‚úÖ Equipos modernos</li>
                        <li class="flex items-center">‚úÖ Urgencias 24/7</li>
                    </ul>
                </div>
                <div class="md:w-2/3 p-5 md:p-8">
                    <form id="appointment-form" class="space-y-5">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
                            <input type="text" id="owner-name" placeholder="Nombre del due√±o" required class="input-field w-full px-4 py-3 bg-gray-50 border border-gray-200 rounded-xl">
                            <input type="tel" id="owner-phone" placeholder="Tel√©fono" required class="input-field w-full px-4 py-3 bg-gray-50 border border-gray-200 rounded-xl">
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
                            <input type="text" id="pet-name" placeholder="Nombre de mascota" required class="input-field w-full px-4 py-3 bg-gray-50 border border-gray-200 rounded-xl">
                            <select id="pet-type" required class="input-field w-full px-4 py-3 bg-gray-50 border border-gray-200 rounded-xl">
                                <option value="Perro">Perro</option>
                                <option value="Gato">Gato</option>
                                <option value="Conejo">Conejo</option>
                                <option value="Otro">Otro</option>
                            </select>
                        </div>
                        <input type="text" id="pet-breed" placeholder="Raza" required class="input-field w-full px-4 py-3 bg-gray-50 border border-gray-200 rounded-xl">
                        <select id="appointment-reason" onchange="window.handleReasonChange()" required class="input-field w-full px-4 py-3 bg-gray-50 border border-gray-200 rounded-xl">
                            <option value="Consulta General - $290">Consulta General - $290</option>
                            <option value="Urgencias - $450">Urgencias - $450</option>
                            <option value="Ba√±o - $100">Ba√±o - $100</option>
                            <option value="Domicilio - $350">A Domicilio - $350</option>
                        </select>
                        <div id="address-container" class="hidden">
                            <textarea id="appointment-address" class="w-full px-4 py-3 bg-gray-50 border border-gray-200 rounded-xl" placeholder="Direcci√≥n completa..."></textarea>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
                            <input type="date" id="appointment-date" required class="input-field w-full px-4 py-3 bg-gray-50 border border-gray-200 rounded-xl">
                            <select id="appointment-time" required class="input-field w-full px-4 py-3 bg-gray-50 border border-gray-200 rounded-xl">
                                <option value="09:00">09:00 AM</option>
                                <option value="12:00">12:00 PM</option>
                                <option value="16:00">04:00 PM</option>
                            </select>
                        </div>
                        <button type="submit" class="w-full bg-green-500 text-white py-4 px-6 rounded-xl font-bold hover:bg-green-600 shadow-lg">Agendar Cita</button>
                    </form>
                </div>
            </div>
        </div>
    </section>

    <!-- Seguimiento Section (Ajustado py-10) -->
    <section id="seguimiento" class="py-10 md:py-16 bg-white">
        <div class="container mx-auto px-4">
            <h2 class="text-3xl font-bold text-center mb-2 text-gray-800">Rastrea tu Pedido</h2>
            <div class="max-w-xl mx-auto mt-8">
                <div class="flex gap-3 mb-8">
                    <input type="text" id="order-search" placeholder="Ej: VET1758..." class="flex-1 px-5 py-3 border border-gray-300 rounded-xl">
                    <button onclick="window.searchOrder()" class="bg-indigo-600 text-white px-8 py-3 rounded-xl font-semibold hover:bg-indigo-700">Buscar</button>
                </div>
                <div id="order-result" class="bg-white rounded-2xl shadow-xl border border-gray-100 overflow-hidden hidden p-6"></div>
            </div>
        </div>
    </section>

    <!-- Admin Section (Ajustado py-10) -->
    <section id="admin" class="py-10 md:py-16 bg-gray-50">
        <div class="container mx-auto px-4">
            <div id="admin-login" class="max-w-md mx-auto bg-white p-8 rounded-2xl shadow-xl border border-gray-100">
                 <div class="text-center mb-8">
                    <span class="text-4xl">üîê</span>
                    <h3 class="text-2xl font-bold text-gray-800 mt-4">Acceso Admin</h3>
                </div>
                <form id="admin-login-form" class="space-y-5">
                    <input type="text" id="admin-username" placeholder="Usuario" required class="w-full px-4 py-3 border rounded-xl">
                    <input type="password" id="admin-password" placeholder="Contrase√±a" required class="w-full px-4 py-3 border rounded-xl">
                    <button type="submit" class="w-full bg-indigo-600 text-white py-3 rounded-xl font-semibold hover:bg-indigo-700">Entrar</button>
                </form>
            </div>

            <div id="admin-panel" class="max-w-7xl mx-auto hidden">
                <div class="bg-white rounded-2xl shadow-xl p-6 mb-8 flex justify-between items-center">
                    <h3 class="text-xl font-bold text-gray-800">Panel de Control</h3>
                    <button onclick="window.logoutAdmin()" class="text-red-500 font-semibold">Cerrar Sesi√≥n</button>
                </div>

                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
                    <button onclick="window.showAdminTab('productos', this)" class="admin-tab bg-indigo-600 text-white p-3 rounded-xl shadow-md">Productos</button>
                    <button onclick="window.showAdminTab('envios', this)" class="admin-tab bg-white text-gray-600 p-3 rounded-xl shadow-sm">Env√≠os</button>
                    <button onclick="window.showAdminTab('citas', this)" class="admin-tab bg-white text-gray-600 p-3 rounded-xl shadow-sm">Citas</button>
                    <button onclick="window.showAdminTab('seguridad', this)" class="admin-tab bg-white text-gray-600 p-3 rounded-xl shadow-sm">Seguridad</button>
                </div>

                <div class="bg-white rounded-2xl shadow-xl border border-gray-100 p-6 min-h-[400px]">
                    <div id="admin-productos" class="admin-content"></div>
                    <div id="admin-envios" class="admin-content hidden"></div>
                    <div id="admin-citas" class="admin-content hidden"></div>
                    <div id="admin-seguridad" class="admin-content hidden"></div>
                </div>
            </div>
        </div>
    </section>

    <!-- Footer -->
    <footer class="bg-gray-900 text-white pt-16 pb-8 mt-auto">
        <div class="container mx-auto px-4 text-center">
            <p>&copy; 2024 Zona Animal. Todos los derechos reservados.</p>
        </div>
    </footer>

    <!-- UI Elements -->
    <div id="cart-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-50 cart-overlay flex justify-end" onclick="window.toggleCart()">
        <div class="cart-sidebar w-full max-w-md bg-white h-full shadow-2xl flex flex-col" onclick="event.stopPropagation()">
            <div class="p-5 border-b flex justify-between items-center bg-gray-50">
                <h2 class="text-xl font-bold">Tu Carrito</h2>
                <button onclick="window.toggleCart()" class="p-2 hover:bg-gray-200 rounded-full">‚úï</button>
            </div>
            <div id="cart-items-container" class="flex-1 overflow-y-auto p-5 space-y-4"></div>
            <div id="cart-footer" class="p-5 border-t bg-gray-50"></div>
        </div>
    </div>

    <!-- Product Details Modal (Ajustado: padding reducido, imagen m√°s peque√±a en m√≥vil) -->
    <div id="product-details-modal" class="modal" onclick="window.closeProductDetails()">
        <div class="bg-white rounded-2xl max-w-4xl w-full mx-4 overflow-hidden shadow-2xl flex flex-col md:flex-row relative animate-[fadeIn_0.3s_ease]" onclick="event.stopPropagation()">
            <button onclick="window.closeProductDetails()" class="absolute top-4 right-4 bg-white/80 hover:bg-white p-2 rounded-full z-10 text-gray-600 hover:text-gray-900 font-bold transition-colors">‚úï</button>
            
            <div class="md:w-1/2 bg-gray-100 flex items-center justify-center p-4">
                <img id="detail-image" src="" class="max-h-[250px] md:max-h-[500px] object-contain w-full rounded-lg shadow-sm" alt="Detalle del producto">
            </div>
            
            <div class="md:w-1/2 p-5 md:p-8 flex flex-col">
                <span id="detail-category" class="text-indigo-600 font-bold uppercase text-xs tracking-wider mb-2"></span>
                <h2 id="detail-name" class="text-2xl md:text-3xl font-bold text-gray-800 mb-4 leading-tight"></h2>
                
                <div class="bg-indigo-50 p-4 rounded-xl border-l-4 border-indigo-500 mb-6">
                    <p id="detail-description" class="text-gray-700 leading-relaxed"></p>
                </div>
                
                <div class="mt-auto pt-6 border-t border-gray-100 flex flex-col gap-4">
                    <div class="flex items-center justify-between">
                        <span class="text-sm text-gray-500 font-medium">Precio:</span>
                        <span id="detail-price" class="text-4xl font-extrabold text-indigo-600"></span>
                    </div>
                    
                    <button id="detail-add-btn" class="w-full bg-indigo-600 text-white py-4 rounded-xl font-bold hover:bg-indigo-700 transition-all transform hover:scale-[1.02] shadow-lg flex items-center justify-center gap-2 text-lg">
                        Agregar al Carrito üõí
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bulk Import Modal -->
    <div id="bulk-import-modal" class="modal">
      <div class="bg-white p-6 rounded-xl max-w-2xl w-full mx-4 shadow-2xl animate-[fadeIn_0.3s_ease]">
        <h3 class="font-bold text-xl mb-4 text-gray-800">Carga Masiva de Productos</h3>
        <p class="text-sm text-gray-600 mb-4">La lista ya est√° precargada con 126 productos del PDF. ¬°Solo dale a importar!</p>
        <textarea id="bulk-json" class="w-full h-64 p-3 border rounded-lg font-mono text-xs focus:ring-2 focus:ring-indigo-500 outline-none" placeholder="Pega tu JSON aqu√≠..."></textarea>
        <div class="flex justify-end gap-3 mt-6">
            <button onclick="document.getElementById('bulk-import-modal').classList.remove('show')" class="px-5 py-2 border rounded-lg hover:bg-gray-50 transition-colors">Cancelar</button>
            <button onclick="window.processBulkImport()" class="px-5 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition-colors shadow-md">Importar Productos</button>
        </div>
      </div>
    </div>

    <div id="checkout-modal" class="modal"></div>
    <div id="confirm-modal" class="modal"></div>
    <div id="edit-product-modal" class="modal"></div>
    <!-- Hidden file input for quick image upload -->
    <input type="file" id="quick-image-upload" accept="image/*" class="hidden">

    <!-- FIREBASE MODULE -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, addDoc, updateDoc, deleteDoc, onSnapshot, query, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- CONFIGURACI√ìN DE USUARIO ---
        const firebaseConfig = {
          apiKey: "AIzaSyCC-swKUQGU93xe_bc7Qts2nhFCji3ZeDs",
          authDomain: "zona-animal-pedidos.firebaseapp.com",
          projectId: "zona-animal-pedidos",
          storageBucket: "zona-animal-pedidos.firebasestorage.app",
          messagingSenderId: "1028482666526",
          appId: "1:1028482666526:web:a136fa73b9b0d884389e0f",
          measurementId: "G-F7VHGPFQD7"
        };

        const appId = "zona-animal-pedidos";

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // State
        let products = [];
        let cart = JSON.parse(localStorage.getItem('zonaAnimalCart')) || [];
        let orders = [];
        let appointments = [];
        let currentFilter = 'todos';
        let isAdminLoggedIn = localStorage.getItem('isAdmin') === 'true';
        let quickUploadProductId = null; // Store ID for quick upload
        
        // --- PRELOADED DATA ---
        const pdfInventory = [{"name":"Dispensador Autom√°tico de Gravedad","price":180,"category":"accesorios","description":"Dispensador de pl√°stico con dep√≥sito transparente de gran capacidad y taz√≥n integrado."},{"name":"Bebedero Autom√°tico","price":180,"category":"accesorios","description":"Recipiente de pl√°stico con sistema de dispensaci√≥n de agua por gravedad."},{"name":"Bebedero Autom√°tico por Gravedad","price":180,"category":"accesorios","description":"Dispensador de agua de pl√°stico blanco y transparente."},{"name":"RedKite Alimento H√°mster","price":150,"category":"producto","description":"Alimento balanceado y granulado para la nutrici√≥n de h√°msters."},{"name":"Collar Isabelino","price":200,"category":"accesorios","description":"Collar protector transparente (cono de la verg√ºenza)."},{"name":"Collar Isabelino de Protecci√≥n","price":100,"category":"accesorios","description":"Cono de pl√°stico protector."},{"name":"Collar Protector de Tela","price":150,"category":"accesorios","description":"Collar c√≥nico de tela suave con estampado."},{"name":"Bot√≠n/Protector Textil","price":80,"category":"accesorios","description":"Accesorio protector textil c√≥nico con dise√±o estampado."},{"name":"Pedigree y Whiskas (Sobre)","price":400,"category":"producto","description":"Bolsas de alimentos comerciales para perros y gatos."},{"name":"Dasner 16x Pet Care Adulto","price":330,"category":"producto","description":"Alimento balanceado para mascotas adultas (20 kg)."},{"name":"Cord√≥n trenzado bicolor","price":50,"category":"accesorios","description":"Peque√±o cord√≥n o cuerda trenzada."},{"name":"Flourish Glue","price":150,"category":"producto","description":"Adhesivo de cianoacrilato para plantas acu√°ticas."},{"name":"Peanuts Bolsas para Desechos","price":50,"category":"accesorios","description":"Rollos de bolsas aromatizadas."},{"name":"REPTILELECTRIC Placa T√©rmica","price":350,"category":"accesorios","description":"Placa t√©rmica de 6 Watts y 18x14 cm."},{"name":"BOYU Ceramic Ring CR-500","price":150,"category":"accesorios","description":"Anillos de cer√°mica porosa para filtraci√≥n."},{"name":"Limpiador Magn√©tico Acuario","price":300,"category":"accesorios","description":"Limpiador magn√©tico flotante para cristales."},{"name":"Ganador BITES","price":20,"category":"producto","description":"Snack o premio para perros."},{"name":"Collar de Cuero","price":100,"category":"accesorios","description":"Correa de cuero ajustable de color marr√≥n."},{"name":"Collar Estampado","price":100,"category":"accesorios","description":"Tira de nylon con dise√±o de conejos."},{"name":"Arn√©s Acolchado","price":100,"category":"accesorios","description":"Arn√©s de paseo con secci√≥n acolchada."},{"name":"LED XPERT L√°mpara 35","price":250,"category":"accesorios","description":"L√°mpara LED empaquetada."},{"name":"Arn√©s Rojo","price":90,"category":"accesorios","description":"Arn√©s de paseo de tela ajustable de color rojo."},{"name":"Arn√©s de Tela","price":80,"category":"accesorios","description":"Arn√©s de sujeci√≥n de tela roja."},{"name":"Arn√©s Camuflaje Gato","price":200,"category":"accesorios","description":"Arn√©s ajustable con dise√±o de camuflaje."},{"name":"Correa Extensible Kanapet","price":200,"category":"accesorios","description":"Correa retr√°ctil de 3 metros."},{"name":"Correas/Arneses Nylon","price":90,"category":"accesorios","description":"Productos de sujeci√≥n de nylon."},{"name":"Collares Surtidos","price":80,"category":"accesorios","description":"Collares ajustables en diferentes colores."},{"name":"Collares Tejidos","price":60,"category":"accesorios","description":"Collares estrechos y coloridos con patrones."},{"name":"Chaleco Salvavidas Mediano","price":300,"category":"accesorios","description":"Chaleco flotante rojo con franjas blancas."},{"name":"Chaleco Perro CH","price":300,"category":"accesorios","description":"Chaleco rojo brillante con capucha."},{"name":"Difusor Aire Acuario","price":20,"category":"accesorios","description":"Piedras difusoras de aire."},{"name":"BIOPRO NitroBacter","price":100,"category":"producto","description":"Bacterias liquidas para acuarios."},{"name":"Vita-Flo","price":50,"category":"producto","description":"Fertilizante l√≠quido para plantas acu√°ticas."},{"name":"Permanganato de Potasio","price":50,"category":"medicamentos","description":"Tratamiento desinfectante y antiparasitario."},{"name":"Acrivelit","price":50,"category":"medicamentos","description":"Tratamiento a base de Acriflavina."},{"name":"Pentabiocare","price":50,"category":"producto","description":"Acondicionador de agua l√≠quido."},{"name":"Somac Vita-Fl","price":50,"category":"producto","description":"Suplemento l√≠quido para plantas."},{"name":"Lomas Crystalize","price":50,"category":"producto","description":"Clarificador de agua para acuarios."},{"name":"LOMAS VERDE PLUS","price":50,"category":"producto","description":"Tratamiento l√≠quido para el agua."},{"name":"Bettera Equipada","price":200,"category":"accesorios","description":"Acuario peque√±o para peces Betta."},{"name":"Acuario (Pecera)","price":250,"category":"accesorios","description":"Tanque de vidrio rectangular."},{"name":"Kit Limpiador Acuario","price":300,"category":"accesorios","description":"Set de herramientas de limpieza."},{"name":"Betta Food (Prodac)","price":80,"category":"producto","description":"Alimento granulado para Betta."},{"name":"XOLOTINAS Juvenil","price":80,"category":"producto","description":"Alimento para ajolotes juveniles."},{"name":"Exotic's Erizos Diet","price":200,"category":"producto","description":"Alimento premium para erizos."},{"name":"Bettazul","price":40,"category":"producto","description":"Alimento en pellets para Betta."},{"name":"IKMAS Algae Discs","price":40,"category":"producto","description":"Alimento a base de algas en disco."},{"name":"TetraWeekend Block","price":100,"category":"producto","description":"Bloque de alimento de liberaci√≥n lenta."},{"name":"Red para Acuario (Fina)","price":40,"category":"accesorios","description":"Red de malla fina con mango."},{"name":"Red Malla M","price":40,"category":"accesorios","description":"Accesorio con marco r√≠gido y malla blanca."},{"name":"Red Acuario (Peque√±a)","price":50,"category":"accesorios","description":"Peque√±a red de malla fina."},{"name":"Lomas TEN Pond Stix","price":200,"category":"producto","description":"Alimento en forma de sticks."},{"name":"Calentador Sunny 25W","price":250,"category":"accesorios","description":"Calentador de inmersi√≥n de vidrio."},{"name":"Calentador 100W","price":300,"category":"accesorios","description":"Calentador sumergible de cristal."},{"name":"Filtro Sunny SPF-1200","price":300,"category":"accesorios","description":"Filtro de potencia para acuarios."},{"name":"Filtro Multiburbujas","price":100,"category":"accesorios","description":"Filtro de agua con efecto multiburbujas."},{"name":"Alimento Iguana Juvenil","price":200,"category":"producto","description":"Alimento fortificado para iguanas."},{"name":"Maternidad Flotante","price":200,"category":"accesorios","description":"Incubadora de pl√°stico flotante."},{"name":"Transportadora","price":500,"category":"accesorios","description":"Jaula de transporte de pl√°stico."},{"name":"VALSYN NF Sobres","price":60,"category":"medicamentos","description":"Antibi√≥tico y expectorante."},{"name":"GASTRYL ORAL","price":250,"category":"medicamentos","description":"Inhibidor de la secreci√≥n g√°strica."},{"name":"FORESTRO","price":250,"category":"medicamentos","description":"Estr√≥geno inyectable."},{"name":"Indigest Inyectable","price":770,"category":"medicamentos","description":"Restaurador gastro-hep√°tico."},{"name":"Herbalvet T.A.","price":800,"category":"medicamentos","description":"Soluci√≥n desinfectante concentrada."},{"name":"Herizul","price":200,"category":"medicamentos","description":"Antis√©ptico l√≠quido de 1000 ml."},{"name":"VITAFORT-A Sobres","price":22,"category":"medicamentos","description":"Multivitam√≠nico para aves."},{"name":"Aminotonic 500ml","price":200,"category":"medicamentos","description":"Soluci√≥n de amino√°cidos y vitaminas."},{"name":"ALFADEX Polvo","price":90,"category":"producto","description":"Insecticida-acaricida con Cipermetrina."},{"name":"Azul Fermark","price":50,"category":"medicamentos","description":"Soluci√≥n cicatrizante y antis√©ptica."},{"name":"ARANDA Bebida Tos","price":200,"category":"medicamentos","description":"Soluci√≥n oral contra la tos."},{"name":"Calfon Fuerte","price":400,"category":"medicamentos","description":"Soluci√≥n inyectable de calcio."},{"name":"NAPZIN","price":400,"category":"medicamentos","description":"Soluci√≥n inyectable de Meglumina de Flunixin."},{"name":"L-Vermizol Vitaminado","price":190,"category":"medicamentos","description":"Antiparasitario y vitam√≠nico."},{"name":"Vitamina K Iny","price":500,"category":"medicamentos","description":"Soluci√≥n inyectable de Vitamina K."},{"name":"Megluxyn-V","price":300,"category":"medicamentos","description":"Antiinflamatorio inyectable."},{"name":"Vigantol ADE Fuerte","price":350,"category":"medicamentos","description":"Concentrado vitam√≠nico inyectable."},{"name":"Iver+ADE NRV","price":128,"category":"medicamentos","description":"Ivermectina con Vitaminas ADE."},{"name":"Ener-Jet B Complex","price":150,"category":"medicamentos","description":"Vitaminas del Complejo B."},{"name":"Vitamina ADE","price":170,"category":"medicamentos","description":"Soluci√≥n inyectable de vitaminas A, D, E."},{"name":"Sural","price":500,"category":"medicamentos","description":"Sedante y tranquilizante inyectable."},{"name":"Super Flumi-Strep","price":300,"category":"medicamentos","description":"Suspensi√≥n antibi√≥tica reforzada."},{"name":"Dexa-Jet NRV","price":300,"category":"medicamentos","description":"Soluci√≥n corticosteroide est√©ril."},{"name":"STOP-ON","price":200,"category":"medicamentos","description":"Antidiarreico en suspensi√≥n oral."},{"name":"Collar Antipulgas Gato","price":200,"category":"producto","description":"Collar antiparasitario Nobleza."},{"name":"Training Pads 14pz","price":150,"category":"producto","description":"Almohadillas absorbentes para entrenamiento."},{"name":"Oleo-Lax Gel","price":150,"category":"medicamentos","description":"Laxante oral herbolario."},{"name":"Dorso Pet Guard Gato","price":280,"category":"medicamentos","description":"Ectoparasiticida spot-on."},{"name":"FRONPet XL","price":280,"category":"medicamentos","description":"Pipeta antiparasitaria >40kg."},{"name":"FRONPet M","price":300,"category":"medicamentos","description":"Pipeta antiparasitaria 10-20kg."},{"name":"FRONPet L","price":300,"category":"medicamentos","description":"Pipeta antiparasitaria 20-40kg."},{"name":"Clean Guard XL","price":300,"category":"medicamentos","description":"Antiparasitario >40kg."},{"name":"Revolution Plus Gato","price":280,"category":"medicamentos","description":"Soluci√≥n t√≥pica 0.5ml."},{"name":"Revolution PLUS Caja","price":800,"category":"medicamentos","description":"Soluci√≥n t√≥pica caja completa."},{"name":"Equipasta","price":290,"category":"medicamentos","description":"Pasta oral de Ivermectina."},{"name":"Actuol 4%","price":100,"category":"medicamentos","description":"Antiparasitario en polvo."},{"name":"Giardicox NRV","price":27,"category":"medicamentos","description":"Tableta para infecciones parasitarias."},{"name":"Giardicox NRV Caja","price":580,"category":"medicamentos","description":"Caja de tabletas antiparasitarias."},{"name":"Meloxi Pets 1mg","price":27,"category":"medicamentos","description":"Tableta antiinflamatoria."},{"name":"Meloxi Pets Caja","price":500,"category":"medicamentos","description":"Caja de tabletas Meloxicam."},{"name":"Fluvi Jet Plus L.A.","price":300,"category":"medicamentos","description":"Medicamento de larga acci√≥n."},{"name":"Doxi Pets 100mg","price":27,"category":"medicamentos","description":"Tableta de Doxiciclina."},{"name":"Doxi Pets Caja","price":500,"category":"medicamentos","description":"Caja de Doxiciclina."},{"name":"Azulvet Spray","price":90,"category":"medicamentos","description":"Spray antis√©ptico y cicatrizante."},{"name":"Sanitor Forte","price":100,"category":"medicamentos","description":"Soluci√≥n antis√©ptica t√≥pica."},{"name":"Aluspray","price":580,"category":"medicamentos","description":"Spray cicatrizante de aluminio."},{"name":"Lepecid Spray","price":200,"category":"medicamentos","description":"Spray antis√©ptico veterinario."},{"name":"TOPAZONE 250ml","price":290,"category":"medicamentos","description":"Aerosol antimicrobiano."},{"name":"TOPAZONE NF 400ml","price":400,"category":"medicamentos","description":"Spray t√≥pico con Florfenicol."},{"name":"Jab√≥n Perro Consentido","price":60,"category":"producto","description":"Jab√≥n antiparasitario."},{"name":"Omepra Jet NRV","price":360,"category":"medicamentos","description":"Omeprazol inyectable."},{"name":"Otic","price":190,"category":"medicamentos","description":"Soluci√≥n √≥tica."},{"name":"Prodol Pets Plus","price":290,"category":"medicamentos","description":"Soluci√≥n oral antiparasitaria."},{"name":"Alin Depot","price":200,"category":"medicamentos","description":"Suspensi√≥n inyectable antiinflamatoria."},{"name":"RESPAIRE Tabletas","price":300,"category":"medicamentos","description":"Mucocin√©tico y expectorante."},{"name":"Enroxil 5%","price":130,"category":"medicamentos","description":"Antibi√≥tico Enrofloxacina."},{"name":"Nutriplus Tabs","price":490,"category":"medicamentos","description":"Suplemento nutricional."},{"name":"BRAVO Shampoo","price":250,"category":"medicamentos","description":"Champ√∫ antiparasitario."},{"name":"BRAVO Spray","price":290,"category":"medicamentos","description":"Spray ectoparasiticida."},{"name":"ESCUDERM Spray","price":280,"category":"medicamentos","description":"Spray dermatol√≥gico."},{"name":"Nutri-Plus Gel","price":580,"category":"medicamentos","description":"Suplemento energ√©tico en gel."},{"name":"Complet Plus Gatos","price":300,"category":"medicamentos","description":"Suspensi√≥n oral para gatos."},{"name":"Gentanazol Spray","price":280,"category":"medicamentos","description":"Soluci√≥n t√≥pica dermatol√≥gica."},{"name":"Regepil","price":580,"category":"medicamentos","description":"Spray regenerador cut√°neo."},{"name":"Energy Pets Gel","price":350,"category":"medicamentos","description":"Gel estimulante del apetito."},{"name":"Stop Jet NRV","price":290,"category":"medicamentos","description":"Antidiarreico l√≠quido."},{"name":"Shield Out","price":350,"category":"medicamentos","description":"Tableta masticable de larga duraci√≥n."}];

        // --- AUTH & INIT ---
        const initAuth = async () => {
            try {
                await signInAnonymously(auth);
                console.log("Conectado a la nube ‚òÅÔ∏è");
                // Preload textarea
                const bulkArea = document.getElementById('bulk-json');
                if(bulkArea) bulkArea.value = JSON.stringify(pdfInventory, null, 2);
            } catch (error) {
                console.error("Auth Error:", error);
                showNotification("Error de conexi√≥n", "error");
            }
        };

        initAuth();

        onAuthStateChanged(auth, (user) => {
            if (user) {
                setupListeners();
            }
        });

        // --- FIRESTORE LISTENERS ---
        const setupListeners = () => {
            const productsRef = collection(db, 'artifacts', appId, 'public', 'data', 'products');
            const ordersRef = collection(db, 'artifacts', appId, 'public', 'data', 'orders');
            const apptsRef = collection(db, 'artifacts', appId, 'public', 'data', 'appointments');

            onSnapshot(productsRef, (snapshot) => {
                products = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                window.renderProducts();
                if(isAdminLoggedIn) window.renderAdminProducts();
                
                const loader = document.getElementById('loader');
                if(loader) {
                    loader.style.opacity = '0';
                    setTimeout(() => loader.remove(), 500);
                }
            }, (error) => console.error("Error productos:", error));

            onSnapshot(ordersRef, (snapshot) => {
                orders = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                if(isAdminLoggedIn) window.renderAdminOrders();
            }, (error) => console.error("Error pedidos:", error));

            onSnapshot(apptsRef, (snapshot) => {
                appointments = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                if(isAdminLoggedIn) window.renderAdminAppointments();
            }, (error) => console.error("Error citas:", error));
        };

        // --- DATA OPERATIONS ---
        window.addProductToDB = async (productData) => {
            try {
                if(!auth.currentUser) return;
                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'products'), productData);
            } catch (e) { console.error(e); window.showNotification("Error al guardar", "error"); }
        };

        window.updateProductInDB = async (id, data) => {
            try {
                if(!auth.currentUser) return;
                await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'products', id), data);
                window.showNotification("Producto actualizado", "success");
            } catch (e) { window.showNotification("Error al actualizar", "error"); }
        };

        window.deleteProductFromDB = async (id) => {
            try {
                if(!auth.currentUser) return;
                await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'products', id));
                window.showNotification("Producto eliminado", "info");
            } catch (e) { window.showNotification("Error al eliminar", "error"); }
        };

        window.addOrderToDB = async (orderData) => {
             if(!auth.currentUser) return;
             await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'orders'), orderData);
        };

        window.addAppointmentToDB = async (apptData) => {
             if(!auth.currentUser) return;
             await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'appointments'), apptData);
        };
        
        window.updateOrderInDB = async (id, status) => {
            if(!auth.currentUser) return;
            await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'orders', id), { status });
        };

        window.deleteOrderFromDB = async (id) => {
            if(!auth.currentUser) return;
            await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'orders', id));
        };

        window.deleteAppointmentFromDB = async (id) => {
            if(!auth.currentUser) return;
            await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'appointments', id));
        };

        // --- UTILS ---
        
        window.showProductDetails = (id) => {
            const product = products.find(p => p.id === id);
            if (!product) return;

            document.getElementById('detail-image').src = product.image || 'https://placehold.co/400x300?text=Sin+Imagen';
            document.getElementById('detail-category').textContent = product.category;
            document.getElementById('detail-name').textContent = product.name;
            document.getElementById('detail-description').textContent = product.description;
            document.getElementById('detail-price').textContent = `$${product.price}`;
            
            const btn = document.getElementById('detail-add-btn');
            btn.onclick = () => {
                window.addToCart(product.id);
                window.closeProductDetails();
            };

            document.getElementById('product-details-modal').classList.add('show');
        };

        window.closeProductDetails = () => {
            document.getElementById('product-details-modal').classList.remove('show');
        };

        window.renderProducts = () => {
            const grid = document.getElementById('products-grid');
            const searchTerm = document.getElementById('search-product')?.value.toLowerCase() || '';
            let filtered = currentFilter === 'todos' ? products : products.filter(p => p.category === currentFilter);
            if (searchTerm) filtered = filtered.filter(p => p.name.toLowerCase().includes(searchTerm));

            grid.innerHTML = filtered.length ? filtered.map(product => `
                <div class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden card-hover flex flex-col h-full group">
                    <div class="relative pt-[75%] bg-gray-100 cursor-pointer overflow-hidden" onclick="window.showProductDetails('${product.id}')">
                        <img src="${product.image}" onerror="this.src='https://placehold.co/400x300?text=Sin+Imagen'" class="absolute top-0 left-0 w-full h-full object-cover transition-transform duration-500 group-hover:scale-110">
                        <div class="absolute inset-0 bg-black/0 group-hover:bg-black/10 transition-colors flex items-center justify-center opacity-0 group-hover:opacity-100">
                            <span class="bg-white text-gray-800 px-4 py-2 rounded-full font-bold shadow-lg transform translate-y-4 group-hover:translate-y-0 transition-all">Ver Detalles</span>
                        </div>
                        <span class="absolute top-3 right-3 bg-white/90 px-2 py-1 rounded-lg text-xs font-bold text-indigo-600 uppercase shadow-sm z-10">${product.category}</span>
                    </div>
                    <div class="p-5 flex flex-col flex-grow">
                        <h3 class="text-lg font-bold text-gray-800 mb-2 cursor-pointer hover:text-indigo-600 transition-colors" onclick="window.showProductDetails('${product.id}')">${product.name}</h3>
                        <p class="text-gray-500 text-sm mb-4 line-clamp-2 flex-grow">${product.description}</p>
                        <div class="flex items-center justify-between mt-auto pt-4 border-t border-gray-50">
                            <span class="text-2xl font-extrabold text-indigo-600">$${product.price}</span>
                            <button onclick="window.addToCart('${product.id}')" class="bg-gray-900 text-white w-10 h-10 rounded-full flex items-center justify-center hover:bg-indigo-600 hover:scale-110 transition-all shadow-lg"><span class="text-lg">+</span></button>
                        </div>
                    </div>
                </div>`).join('') : '<div class="col-span-full py-12 text-center text-gray-400"><p>No hay productos.</p></div>';
        };

        window.filterProducts = (cat, btn) => {
            currentFilter = cat;
            document.querySelectorAll('.filter-btn').forEach(b => { b.classList.remove('bg-indigo-600', 'text-white'); b.classList.add('bg-white', 'text-gray-600'); });
            btn.classList.remove('bg-white', 'text-gray-600'); btn.classList.add('bg-indigo-600', 'text-white');
            window.renderProducts();
        };
        
        window.searchProducts = () => window.renderProducts();

        window.toggleCart = () => document.body.classList.toggle('cart-open');
        
        window.addToCart = (id) => {
            const prod = products.find(p => p.id === id);
            const item = cart.find(i => i.id === id);
            if(item) item.quantity++; else cart.push({...prod, quantity: 1});
            saveCart(); window.renderCart(); window.showNotification("Agregado al carrito", "success");
        };

        window.removeFromCart = (id) => { cart = cart.filter(i => i.id !== id); saveCart(); window.renderCart(); };
        window.updateQuantity = (id, chg) => {
            const item = cart.find(i => i.id === id);
            if(item) { item.quantity += chg; if(item.quantity <= 0) window.removeFromCart(id); else { saveCart(); window.renderCart(); } }
        };
        
        function saveCart() { localStorage.setItem('zonaAnimalCart', JSON.stringify(cart)); }

        window.renderCart = () => {
            const container = document.getElementById('cart-items-container');
            const footer = document.getElementById('cart-footer');
            document.getElementById('cart-count').textContent = cart.reduce((s, i) => s + i.quantity, 0);
            
            if(cart.length === 0) {
                container.innerHTML = '<div class="text-center text-gray-400 py-10">Carrito vac√≠o</div>';
                footer.innerHTML = '';
            } else {
                container.innerHTML = cart.map(i => `
                    <div class="flex gap-3 items-center bg-gray-50 p-2 rounded-lg">
                        <img src="${i.image}" class="w-12 h-12 rounded object-cover">
                        <div class="flex-1"><div class="font-bold text-sm">${i.name}</div><div class="text-xs text-indigo-600">$${i.price} x ${i.quantity}</div></div>
                        <div class="flex items-center gap-2"><button onclick="window.updateQuantity('${i.id}', -1)" class="w-6 h-6 bg-gray-200 rounded">-</button><span>${i.quantity}</span><button onclick="window.updateQuantity('${i.id}', 1)" class="w-6 h-6 bg-gray-200 rounded">+</button></div>
                    </div>`).join('');
                const total = cart.reduce((s, i) => s + (i.price * i.quantity), 0);
                footer.innerHTML = `<div class="flex justify-between font-bold mb-3"><span>Total</span><span>$${total.toFixed(2)}</span></div><button onclick="window.showCheckoutForm()" class="w-full bg-green-500 text-white py-3 rounded-xl font-bold">Pagar</button>`;
            }
        };

        // Quick Image Upload Logic
        window.triggerQuickUpload = (id) => {
            quickUploadProductId = id;
            document.getElementById('quick-image-upload').click();
        };

        document.getElementById('quick-image-upload').addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (file && quickUploadProductId) {
                try {
                    window.showNotification("Subiendo imagen...", "info");
                    const img = await processImage(file);
                    await window.updateProductInDB(quickUploadProductId, { image: img });
                    quickUploadProductId = null; // Reset
                    e.target.value = ''; // Reset input
                } catch(err) {
                    window.showNotification("Error al subir imagen", "error");
                }
            }
        });

        // Bulk Import Logic
        window.processBulkImport = async () => {
            const text = document.getElementById('bulk-json').value;
            try {
                const items = JSON.parse(text);
                if(!Array.isArray(items)) throw new Error("El formato debe ser una lista [...]");
                
                window.showNotification("Iniciando carga masiva...", "info");
                let count = 0;
                // Using Promise.all for speed, but enforcing simple image placeholder
                const promises = items.map(item => {
                    if(item.name && item.price) {
                        count++;
                        return window.addProductToDB({
                            name: item.name,
                            price: Number(item.price),
                            category: item.category || 'otros',
                            description: item.description || '',
                            // Use a distinctive placeholder for items needing images
                            image: item.image || 'https://placehold.co/400x300?text=Subir+Foto' 
                        });
                    }
                });
                
                await Promise.all(promises);
                window.showNotification(`${count} productos importados!`, 'success');
                document.getElementById('bulk-import-modal').classList.remove('show');
                // No clearing value so user can retry if needed or see what they pasted
            } catch(e) {
                alert("Error en el JSON: " + e.message);
            }
        };

        // Admin Logic Update
        window.renderAdminPanel = () => {
            if(!isAdminLoggedIn) { 
                document.getElementById('admin-login').classList.remove('hidden'); 
                document.getElementById('admin-panel').classList.add('hidden'); 
                return; 
            }
            document.getElementById('admin-login').classList.add('hidden'); 
            document.getElementById('admin-panel').classList.remove('hidden');
            window.renderAdminProducts();
        };

        window.renderAdminProducts = () => {
            document.getElementById('admin-productos').innerHTML = `
            <div class="grid lg:grid-cols-3 gap-6">
                <div class="lg:col-span-1 bg-gray-50 p-4 rounded-xl h-fit sticky top-4">
                    <h4 class="font-bold mb-3">Nuevo Producto</h4>
                    <form id="add-prod-form" class="space-y-3">
                        <input id="np-name" placeholder="Nombre" class="w-full p-2 border rounded" required>
                        <input id="np-price" type="number" placeholder="Precio" class="w-full p-2 border rounded" required>
                        <select id="np-cat" class="w-full p-2 border rounded">
                            <option value="alimento">Alimento</option>
                            <option value="juguetes">Juguetes</option>
                            <option value="medicamentos">Medicamentos</option>
                            <option value="accesorios">Accesorios</option>
                            <option value="producto">Producto</option>
                        </select>
                        <input type="file" id="np-file" accept="image/*" class="w-full text-sm">
                        <textarea id="np-desc" placeholder="Descripci√≥n" class="w-full p-2 border rounded"></textarea>
                        <button type="submit" class="w-full bg-indigo-600 text-white py-2 rounded hover:bg-indigo-700">Guardar en Nube</button>
                    </form>
                    <div class="mt-4 pt-4 border-t">
                        <button onclick="document.getElementById('bulk-import-modal').classList.add('show')" class="w-full text-indigo-600 font-bold hover:underline flex items-center justify-center gap-2">
                            <span>‚ö° Carga Masiva JSON</span>
                        </button>
                    </div>
                </div>
                <div class="lg:col-span-2 space-y-2">
                    ${products.map(p => {
                        const isPlaceholder = !p.image || p.image.includes('placehold.co');
                        return `<div class="flex justify-between items-center bg-white p-3 rounded border shadow-sm group">
                        <div class="flex gap-3 items-center">
                            <div class="relative cursor-pointer" onclick="window.triggerQuickUpload('${p.id}')" title="Clic para cambiar imagen">
                                <img src="${p.image}" class="w-12 h-12 rounded object-cover ${isPlaceholder ? 'opacity-70' : ''}">
                                ${isPlaceholder ? '<div class="absolute inset-0 flex items-center justify-center bg-black/20 rounded text-xs text-white font-bold">+Foto</div>' : ''}
                                <div class="absolute inset-0 bg-black/50 hidden group-hover:flex items-center justify-center rounded text-white text-xs">Editar</div>
                            </div>
                            <div>
                                <div class="font-bold">${p.name}</div>
                                <div class="text-xs text-gray-500">$${p.price} | ${p.category}</div>
                            </div>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="window.editProduct('${p.id}')" class="text-blue-500 p-2 hover:bg-blue-50 rounded">‚úèÔ∏è</button>
                            <button onclick="window.deleteProductFromDB('${p.id}')" class="text-red-500 p-2 hover:bg-red-50 rounded">üóëÔ∏è</button>
                        </div>
                    </div>`}).join('')}
                </div>
            </div>`;
            document.getElementById('add-prod-form').addEventListener('submit', async e => {
                e.preventDefault();
                const file = document.getElementById('np-file').files[0];
                const img = file ? await processImage(file) : 'https://placehold.co/400?text=No+Image';
                await window.addProductToDB({
                    name: document.getElementById('np-name').value,
                    price: Number(document.getElementById('np-price').value),
                    category: document.getElementById('np-cat').value,
                    description: document.getElementById('np-desc').value,
                    image: img
                });
                window.showNotification("Producto guardado", "success");
                e.target.reset();
            });
        };

        window.renderAdminOrders = () => {
            document.getElementById('admin-envios').innerHTML = orders.length ? orders.map(o => `
                <div class="bg-white p-4 rounded shadow mb-2 border-l-4 border-indigo-500">
                    <div class="flex justify-between font-bold"><span>#${o.orderId || 'PEDIDO'}</span><span>$${o.total}</span></div>
                    <div class="text-sm text-gray-600 my-1">${o.customer} - ${o.phone}</div>
                    <div class="flex justify-between items-center mt-2">
                        <span class="uppercase text-xs bg-gray-200 px-2 py-1 rounded font-bold">${o.status || 'nuevo'}</span>
                        <div class="flex gap-2"><button onclick="window.updateOrderInDB('${o.id}', 'en-camino')" class="text-xs bg-blue-100 text-blue-700 px-2 py-1 rounded">En Camino</button><button onclick="window.deleteOrderFromDB('${o.id}')" class="text-xs bg-red-100 text-red-700 px-2 py-1 rounded">Borrar</button></div>
                    </div>
                </div>`).join('') : '<p class="text-gray-500">Sin pedidos recientes.</p>';
        };

        window.renderAdminAppointments = () => {
             document.getElementById('admin-citas').innerHTML = appointments.length ? appointments.map(a => `
                <div class="bg-white p-4 rounded shadow mb-2 border-l-4 border-green-500">
                    <div class="font-bold">${a.pet} (${a.owner})</div>
                    <div class="text-sm">${a.date} - ${a.time}</div>
                    <div class="text-xs text-gray-500 mt-1">${a.reason}</div>
                    <button onclick="window.deleteAppointmentFromDB('${a.id}')" class="text-red-500 text-xs mt-2 underline">Cancelar</button>
                </div>`).join('') : '<p class="text-gray-500">Agenda libre.</p>';
        };

        window.showAdminTab = (tab, btn) => {
            document.querySelectorAll('.admin-content').forEach(e => e.classList.add('hidden'));
            document.getElementById(`admin-${tab}`).classList.remove('hidden');
            document.querySelectorAll('.admin-tab').forEach(b => { b.classList.remove('bg-indigo-600','text-white'); b.classList.add('bg-white','text-gray-600'); });
            btn.classList.remove('bg-white','text-gray-600'); btn.classList.add('bg-indigo-600','text-white');
            if(tab === 'productos') window.renderAdminProducts();
            if(tab === 'envios') window.renderAdminOrders();
            if(tab === 'citas') window.renderAdminAppointments();
        };

        window.editProduct = (id) => {
            const p = products.find(x => x.id === id);
            if(!p) return;
            const modal = document.getElementById('edit-product-modal');
            
            modal.innerHTML = `
            <div class="bg-white p-6 rounded-xl max-w-md w-full mx-4 animate-[slideUp_0.3s_ease]">
                <h3 class="font-bold text-lg mb-4">Editar Producto</h3>
                <form id="edit-form" class="space-y-3">
                    <div class="text-center mb-2">
                        <img src="${p.image}" class="h-20 w-20 object-cover rounded mx-auto mb-2 border">
                        <label class="block text-sm text-blue-600 cursor-pointer hover:underline">
                            Cambiar Imagen
                            <input type="file" id="ep-file" accept="image/*" class="hidden">
                        </label>
                    </div>
                    <input id="ep-name" value="${p.name}" placeholder="Nombre" class="w-full p-2 border rounded" required>
                    <input id="ep-price" type="number" value="${p.price}" placeholder="Precio" class="w-full p-2 border rounded" required>
                    <select id="ep-cat" class="w-full p-2 border rounded">
                        <option value="alimento" ${p.category === 'alimento' ? 'selected' : ''}>Alimento</option>
                        <option value="juguetes" ${p.category === 'juguetes' ? 'selected' : ''}>Juguetes</option>
                        <option value="medicamentos" ${p.category === 'medicamentos' ? 'selected' : ''}>Medicamentos</option>
                        <option value="accesorios" ${p.category === 'accesorios' ? 'selected' : ''}>Accesorios</option>
                        <option value="producto" ${p.category === 'producto' ? 'selected' : ''}>Producto</option>
                    </select>
                    <textarea id="ep-desc" placeholder="Descripci√≥n" class="w-full p-2 border rounded">${p.description}</textarea>
                    <div class="flex justify-end gap-2">
                        <button type="button" onclick="document.getElementById('edit-product-modal').classList.remove('show')" class="px-3 py-1 border rounded hover:bg-gray-50">Cancelar</button>
                        <button type="submit" class="px-3 py-1 bg-blue-600 text-white rounded hover:bg-blue-700">Guardar</button>
                    </div>
                </form>
            </div>`;
            
            modal.classList.add('show');
            
            document.getElementById('edit-form').addEventListener('submit', async e => {
                e.preventDefault();
                const fileInput = document.getElementById('ep-file');
                let imageToSave = p.image;

                if (fileInput.files && fileInput.files[0]) {
                    try {
                        imageToSave = await processImage(fileInput.files[0]);
                    } catch (err) {
                        console.error("Error processing image", err);
                    }
                }

                await window.updateProductInDB(id, { 
                    name: document.getElementById('ep-name').value, 
                    price: Number(document.getElementById('ep-price').value),
                    category: document.getElementById('ep-cat').value, 
                    description: document.getElementById('ep-desc').value,
                    image: imageToSave
                });
                modal.classList.remove('show');
            });
        };

        // Checkout Logic
        window.showCheckoutForm = () => {
            const modal = document.getElementById('checkout-modal');
            modal.innerHTML = `<div class="bg-white p-6 rounded-xl max-w-md w-full mx-4 animate-[slideUp_0.3s_ease]"><h3 class="font-bold text-lg mb-4">Finalizar</h3><form id="checkout-form" class="space-y-3"><input id="c-name" placeholder="Nombre" class="w-full p-2 border rounded" required><input id="c-phone" placeholder="Tel√©fono" class="w-full p-2 border rounded" required><textarea id="c-addr" placeholder="Direcci√≥n" class="w-full p-2 border rounded" required></textarea><button type="submit" class="w-full bg-green-600 text-white py-3 rounded font-bold">Enviar Pedido</button></form><button onclick="document.getElementById('checkout-modal').classList.remove('show')" class="mt-2 text-gray-500 text-sm underline w-full">Cancelar</button></div>`;
            modal.classList.add('show');
            document.getElementById('checkout-form').addEventListener('submit', async e => {
                e.preventDefault();
                const order = { orderId: 'VET'+Date.now().toString().slice(-4), customer: document.getElementById('c-name').value, phone: document.getElementById('c-phone').value, address: document.getElementById('c-addr').value, total: cart.reduce((s,i)=>s+(i.price*i.quantity),0), status: 'nuevo', items: cart };
                
                // Send Whatsapp
                let msg = `Hola Zona Animal! Pedido ${order.orderId}: ${order.customer} (${order.phone}). Direcci√≥n: ${order.address}. Total: $${order.total}.`;
                window.open(`https://wa.me/5212452070033?text=${encodeURIComponent(msg)}`, '_blank');
                
                await window.addOrderToDB(order);
                cart = []; saveCart(); window.renderCart(); document.getElementById('checkout-modal').classList.remove('show'); window.toggleCart();
            });
        };
        
        // Appointment Logic
        document.getElementById('appointment-form').addEventListener('submit', async e => {
            e.preventDefault();
            const appt = {
                owner: document.getElementById('owner-name').value,
                phone: document.getElementById('owner-phone').value,
                pet: document.getElementById('pet-name').value,
                reason: document.getElementById('appointment-reason').value,
                date: document.getElementById('appointment-date').value,
                time: document.getElementById('appointment-time').value
            };
            let msg = `Cita Veterinaria: ${appt.owner} con mascota ${appt.pet}. Motivo: ${appt.reason}. Fecha: ${appt.date} a las ${appt.time}.`;
            window.open(`https://wa.me/5212452070033?text=${encodeURIComponent(msg)}`, '_blank');
            await window.addAppointmentToDB(appt);
            e.target.reset();
        });

        // Admin Login
        document.getElementById('admin-login-form').addEventListener('submit', e => {
            e.preventDefault();
            if(document.getElementById('admin-username').value === 'admin' && document.getElementById('admin-password').value === 'password123') {
                isAdminLoggedIn = true; localStorage.setItem('isAdmin', 'true'); window.renderAdminPanel();
            } else window.showNotification('Datos incorrectos', 'error');
        });
        window.logoutAdmin = () => { isAdminLoggedIn = false; localStorage.removeItem('isAdmin'); window.renderAdminPanel(); };

        // Helpers
        window.showNotification = (msg, type) => {
            const div = document.createElement('div'); div.className = `fixed top-20 right-4 px-6 py-3 rounded shadow-lg text-white z-[2000] animate-[slideUp_0.3s_ease] ${type === 'error' ? 'bg-red-500' : 'bg-green-500'}`; div.textContent = msg; document.body.appendChild(div); setTimeout(() => div.remove(), 3000);
        };
        window.scrollToSection = (id) => document.getElementById(id)?.scrollIntoView({behavior: 'smooth'});
        window.toggleMobileMenu = () => document.getElementById('mobile-menu').classList.toggle('hidden');
        window.searchOrder = () => {
             const id = document.getElementById('order-search').value; 
             const o = orders.find(x => x.orderId == id || x.id == id);
             const res = document.getElementById('order-result');
             res.classList.remove('hidden');
             res.innerHTML = o ? `<h3 class="font-bold">Pedido #${o.orderId}</h3><p>Estado: <span class="font-bold text-indigo-600 uppercase">${o.status}</span></p><p>Total: $${o.total}</p>` : '<p>No encontrado</p>';
        };
        window.handleReasonChange = () => {
             const val = document.getElementById('appointment-reason').value;
             document.getElementById('address-container').classList.toggle('hidden', !val.includes('Domicilio'));
        };

        // Image Compressor
        const processImage = (file) => new Promise((resolve) => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = (e) => {
                const img = new Image(); img.src = e.target.result;
                img.onload = () => {
                    const cvs = document.createElement('canvas'); const ctx = cvs.getContext('2d');
                    const scale = Math.min(500/img.width, 500/img.height);
                    cvs.width = img.width * scale; cvs.height = img.height * scale;
                    ctx.drawImage(img,0,0,cvs.width,cvs.height);
                    resolve(cvs.toDataURL('image/jpeg', 0.7));
                };
            };
        });

        // Render initial empty state
        window.renderProducts();
        window.renderCart();
        window.renderAdminPanel();

    </script>
</body>
</html>
