<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pedidos y Citas - Veterinaria Zona Animal</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Iconos de Phosphor Icons -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f0f2f5; }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 10px; }
        ::-webkit-scrollbar-thumb { background: #888; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }
        .fade-in { animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body class="antialiased text-gray-800">

    <!-- Contenedor Principal -->
    <div class="min-h-screen flex flex-col lg:flex-row p-4 gap-4">

        <!-- Columna Izquierda: Catálogo de Productos y Servicios -->
        <div class="lg:w-3/5 flex flex-col h-full">
            <header class="mb-4">
                <h1 class="text-3xl font-bold text-gray-900 flex items-center gap-2">
                    <i class="ph-bold ph-paw-print text-cyan-600"></i>
                    Veterinaria Zona Animal
                </h1>
                <p class="text-gray-500 mt-1">Explora nuestros productos y agenda una cita.</p>
            </header>
            
            <div id="items-container" class="bg-white p-4 rounded-2xl shadow-md flex-grow overflow-y-auto" style="max-height: 85vh;">
                <!-- El catálogo se generará aquí -->
            </div>
        </div>

        <!-- Columna Derecha: Carrito y Formulario de Pedido -->
        <div class="lg:w-2/5 flex flex-col">
            <div class="bg-white rounded-2xl shadow-lg flex flex-col h-full p-6">
                
                <!-- Datos del Cliente -->
                <div class="mb-4 border-b pb-4">
                    <h2 class="text-xl font-semibold mb-3 flex items-center gap-2">
                        <i class="ph-bold ph-user-circle text-cyan-600"></i>
                        Tus Datos
                    </h2>
                    <div class="space-y-3">
                        <input type="text" id="customer-name" placeholder="Tu Nombre Completo *" class="w-full p-2 border border-gray-300 rounded-lg bg-gray-50">
                        <input type="tel" id="customer-phone" placeholder="Tu Teléfono de WhatsApp *" class="w-full p-2 border border-gray-300 rounded-lg bg-gray-50">
                        <textarea id="customer-address" placeholder="Tu Dirección (para envíos o citas a domicilio)" class="w-full p-2 border border-gray-300 rounded-lg bg-gray-50 h-20 resize-none"></textarea>
                    </div>
                </div>

                <!-- Carrito de Pedidos -->
                <div id="cart-container" class="flex-grow overflow-y-auto pr-2">
                    <p id="empty-cart-message" class="text-center text-gray-400 my-16">
                        <i class="ph-light ph-shopping-cart text-6xl"></i><br>
                        Tu carrito está vacío
                    </p>
                    <div id="cart-products-section"></div>
                    <div id="cart-appointments-section"></div>
                </div>

                <!-- Resumen y Botón Final -->
                <div class="border-t pt-4 mt-4 space-y-3">
                    <div class="flex justify-between font-bold text-2xl text-cyan-700">
                        <span>Total:</span>
                        <span id="total">$0.00</span>
                    </div>
                    <button id="submit-order-btn" onclick="processOrder()" class="w-full bg-green-500 text-white font-bold py-3 px-4 rounded-lg hover:bg-green-600 transition-colors flex items-center justify-center gap-2 text-lg">
                        <i class="ph-bold ph-whatsapp-logo"></i>
                        Realizar Pedido por WhatsApp
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modal de Éxito -->
    <div id="success-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
        <div class="bg-white rounded-2xl p-8 text-center shadow-2xl max-w-sm mx-4 fade-in">
            <i class="ph-bold ph-check-circle text-8xl text-green-500 mb-4"></i>
            <h3 class="text-2xl font-bold mb-2">¡Pedido Enviado!</h3>
            <p class="text-gray-600 mb-6">Hemos recibido tu pedido correctamente. Nos pondremos en contacto contigo para confirmar.</p>
            <button onclick="closeSuccessModal()" class="bg-cyan-600 text-white font-bold py-2 px-8 rounded-lg hover:bg-cyan-700 transition-colors">Aceptar</button>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, serverTimestamp, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- CONFIGURACIÓN DE FIREBASE ---
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'zona-animal-app';
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        let db;

        // --- BASE DE DATOS LOCAL ---
        const database = {
            "Productos": [
                { id: 'p1', name: 'Alimento para Cachorro 3kg', price: 350.00, type: 'product' },
                { id: 'p2', name: 'Alimento para Adulto 10kg', price: 890.00, type: 'product' },
                { id: 'p3', name: 'Collar Antipulgas', price: 250.00, type: 'product' },
                { id: 'p4', name: 'Juguete Hueso de Goma', price: 120.50, type: 'product' },
            ],
            "Servicios": [
                { id: 's1', name: 'Consulta General', price: 400.00, type: 'service' },
                { id: 's2', name: 'Vacuna Puppy', price: 380.00, type: 'service' },
                { id: 's3', name: 'Estética Canina', price: 550.00, type: 'service' },
                { id: 's4', name: 'Desparasitación', price: 200.00, type: 'service' },
            ]
        };
        const DELIVERY_ITEM = { id: 'delivery', name: 'Servicio a Domicilio', price: 50.00, type: 'service_fee' };

        // --- ESTADO DE LA APLICACIÓN ---
        let cart = [];

        // --- ELEMENTOS DEL DOM ---
        const itemsContainer = document.getElementById('items-container');
        const cartContainer = document.getElementById('cart-container');
        const emptyCartMessage = document.getElementById('empty-cart-message');
        const totalEl = document.getElementById('total');
        const customerNameEl = document.getElementById('customer-name');
        const customerPhoneEl = document.getElementById('customer-phone');
        const customerAddressEl = document.getElementById('customer-address');
        const cartProductsSection = document.getElementById('cart-products-section');
        const cartAppointmentsSection = document.getElementById('cart-appointments-section');
        const successModal = document.getElementById('success-modal');
        const submitOrderBtn = document.getElementById('submit-order-btn');

        // --- INICIALIZACIÓN DE FIREBASE ---
        async function initFirebase() {
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                const auth = getAuth(app);
                setLogLevel('debug');

                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (error) {
                console.error("Error al inicializar Firebase:", error);
                alert("No se pudo conectar con el servicio de pedidos. Por favor, intente más tarde.");
                submitOrderBtn.disabled = true;
                submitOrderBtn.textContent = "Servicio no disponible";
            }
        }

        // --- FUNCIONES DE RENDERIZADO ---
        function renderCatalog() {
            itemsContainer.innerHTML = '';
            for (const category in database) {
                const categoryTitle = document.createElement('h3');
                categoryTitle.className = 'text-xl font-semibold text-gray-700 mt-4 mb-3 first:mt-0';
                categoryTitle.textContent = category;
                itemsContainer.appendChild(categoryTitle);
                const grid = document.createElement('div');
                grid.className = 'grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-3';
                database[category].forEach(item => {
                    const itemButton = document.createElement('button');
                    itemButton.className = 'bg-gray-50 p-3 rounded-lg text-left hover:bg-cyan-100 hover:shadow-md transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-cyan-500';
                    itemButton.onclick = () => addItemToCart(item);
                    itemButton.innerHTML = `<p class="font-semibold text-gray-800">${item.name}</p><p class="text-cyan-600 font-bold mt-1">$${item.price.toFixed(2)}</p>`;
                    grid.appendChild(itemButton);
                });
                itemsContainer.appendChild(grid);
            }
        }
        
        function updateCart() {
            emptyCartMessage.style.display = cart.length === 0 ? 'block' : 'none';
            cartProductsSection.innerHTML = '';
            cartAppointmentsSection.innerHTML = '';

            const products = cart.filter(item => item.type === 'product');
            const services = cart.filter(item => item.type === 'service');
            
            if (products.length > 0) {
                let productsHtml = '<h3 class="text-lg font-semibold text-gray-700 mb-2">Productos en tu pedido:</h3><div class="space-y-2">';
                products.forEach((item) => {
                    const originalIndex = cart.findIndex(cartItem => cartItem.id === item.id);
                    productsHtml += `
                        <div class="flex justify-between items-center bg-gray-50 p-2 rounded-lg fade-in">
                            <span>${item.name}</span>
                            <div class="flex items-center gap-3">
                                <span class="font-semibold">$${item.price.toFixed(2)}</span>
                                <button onclick="window.removeItemFromCart(${originalIndex})" class="text-red-500 hover:text-red-700"><i class="ph-bold ph-x-circle text-xl"></i></button>
                            </div>
                        </div>`;
                });
                productsHtml += '</div>';
                cartProductsSection.innerHTML = productsHtml;
            }

            if (services.length > 0) {
                let appointmentsHtml = '<h3 class="text-lg font-semibold text-gray-700 mt-4 mb-2">Agendar Cita(s):</h3><div class="space-y-4">';
                services.forEach((item) => {
                    const originalIndex = cart.findIndex(cartItem => cartItem.id === item.id);
                    appointmentsHtml += `
                        <div class="bg-gray-50 p-3 rounded-lg fade-in">
                            <div class="flex justify-between items-center mb-3">
                                <span class="font-semibold">${item.name}</span>
                                <button onclick="window.removeItemFromCart(${originalIndex})" class="text-red-500 hover:text-red-700"><i class="ph-bold ph-x-circle text-xl"></i></button>
                            </div>
                            <div class="grid grid-cols-2 gap-2 text-sm">
                                <input type="date" id="date-${item.id}" class="w-full p-2 border border-gray-300 rounded-lg">
                                <select id="time-${item.id}" class="w-full p-2 border border-gray-300 rounded-lg">
                                    <option>9:00 AM - 12:00 PM</option>
                                    <option>12:00 PM - 3:00 PM</option>
                                    <option>3:00 PM - 6:00 PM</option>
                                </select>
                                <div class="col-span-2 flex gap-4 mt-1">
                                    <label><input type="radio" name="location-${item.id}" value="Local" checked onchange="window.updateDeliveryFee()"> En Local</label>
                                    <label><input type="radio" name="location-${item.id}" value="Domicilio" onchange="window.updateDeliveryFee()"> A Domicilio</label>
                                </div>
                            </div>
                        </div>`;
                });
                appointmentsHtml += '</div>';
                cartAppointmentsSection.innerHTML = appointmentsHtml;
            }

            const total = cart.reduce((sum, item) => sum + item.price, 0);
            totalEl.textContent = `$${total.toFixed(2)}`;
        }

        // --- LÓGICA DEL CARRITO Y PEDIDO ---
        window.addItemToCart = (item) => {
            if (cart.some(cartItem => cartItem.id === item.id)) {
                alert("Este artículo ya está en tu carrito.");
                return;
            }
            cart.push(item);
            updateCart();
            window.updateDeliveryFee();
        }

        window.removeItemFromCart = (index) => {
            cart.splice(index, 1);
            updateCart();
            window.updateDeliveryFee();
        }

        window.updateDeliveryFee = () => {
            const isHomeService = cart.some(item => {
                if (item.type === 'service') {
                    const radio = document.querySelector(`input[name="location-${item.id}"]:checked`);
                    return radio && radio.value === 'Domicilio';
                }
                return false;
            });
            const hasDeliveryFee = cart.some(item => item.id === 'delivery');

            if (isHomeService && !hasDeliveryFee) {
                cart.push(DELIVERY_ITEM);
            } else if (!isHomeService && hasDeliveryFee) {
                const deliveryIndex = cart.findIndex(item => item.id === 'delivery');
                if (deliveryIndex > -1) cart.splice(deliveryIndex, 1);
            }
            updateCart();
        }

        window.processOrder = async () => {
            if (!db) {
                alert("El servicio de pedidos no está disponible. Intente más tarde.");
                return;
            }
            
            const name = customerNameEl.value.trim();
            const phone = customerPhoneEl.value.trim();
            const address = customerAddressEl.value.trim();

            if (cart.length === 0) {
                alert("Tu carrito está vacío."); return;
            }
            if (!name || !phone) {
                alert("Por favor, ingresa tu nombre y teléfono."); return;
            }
            const needsAddress = cart.some(item => {
                 if (item.type === 'service') {
                    const radio = document.querySelector(`input[name="location-${item.id}"]:checked`);
                    return radio && radio.value === 'Domicilio';
                }
                return item.type === 'product';
            });
            if (needsAddress && !address) {
                alert("Por favor, ingresa tu dirección para el envío o la cita a domicilio."); return;
            }

            // Recopilar datos de la cita
            let appointmentInfo = null;
            const services = cart.filter(item => item.type === 'service');
            if (services.length > 0) {
                const mainService = services[0]; // Simplificado para tomar datos de la primera cita
                appointmentInfo = {
                    date: document.getElementById(`date-${mainService.id}`).value || 'No especificada',
                    time: document.getElementById(`time-${mainService.id}`).value,
                    location: document.querySelector(`input[name="location-${mainService.id}"]:checked`).value
                };
            }

            const total = cart.reduce((sum, item) => sum + item.price, 0);

            // Crear el objeto del pedido
            const orderData = {
                customerInfo: { name, phone, address },
                items: cart.map(({id, name, price, type}) => ({id, name, price, type})), // Guardar solo info necesaria
                appointmentInfo,
                total,
                status: 'Pendiente',
                timestamp: serverTimestamp()
            };

            // Guardar en Firestore
            try {
                submitOrderBtn.disabled = true;
                submitOrderBtn.innerHTML = `<i class="ph-bold ph-spinner animate-spin"></i> Procesando...`;
                const ordersCollectionPath = `/artifacts/${appId}/public/data/orders`;
                await addDoc(collection(db, ordersCollectionPath), orderData);
                
                // Mostrar modal de éxito y limpiar
                successModal.classList.remove('hidden');
                sendWhatsAppNotification(orderData); // Opcional: notificar también por WhatsApp
                cart = [];
                customerNameEl.value = '';
                customerPhoneEl.value = '';
                customerAddressEl.value = '';
                updateCart();

            } catch (error) {
                console.error("Error al guardar el pedido:", error);
                alert("Hubo un problema al enviar tu pedido. Por favor, inténtalo de nuevo.");
            } finally {
                submitOrderBtn.disabled = false;
                submitOrderBtn.innerHTML = `<i class="ph-bold ph-whatsapp-logo"></i> Realizar Pedido por WhatsApp`;
            }
        }

        function sendWhatsAppNotification(orderData) {
            let message = `🐾 *Confirmación de Pedido - Zona Animal* 🐾\n\n`;
            message += `¡Hola *${orderData.customerInfo.name}*! Hemos recibido tu pedido con los siguientes detalles:\n\n`;
            orderData.items.forEach(item => {
                message += `▪️ ${item.name} - $${item.price.toFixed(2)}\n`;
            });
            if (orderData.appointmentInfo) {
                message += `\n*Cita Agendada:*\n`;
                message += `   - Fecha: ${orderData.appointmentInfo.date}\n`;
                message += `   - Lugar: ${orderData.appointmentInfo.location}\n`;
            }
            message += `\n*Total: $${orderData.total.toFixed(2)}*\n\n`;
            message += `Nos pondremos en contacto contigo en breve para confirmar todo. ¡Gracias!`;
            
            const encodedMessage = encodeURIComponent(message);
            const businessPhoneNumber = "522452070033";
            const whatsappUrl = `https://api.whatsapp.com/send?phone=${businessPhoneNumber}&text=${encodedMessage}`;
            window.open(whatsappUrl, '_blank');
        }
        
        window.closeSuccessModal = () => {
            successModal.classList.add('hidden');
        }

        // --- INICIALIZACIÓN ---
        document.addEventListener('DOMContentLoaded', () => {
            initFirebase();
            renderCatalog();
            updateCart();
        });
    </script>
</body>
</html>
